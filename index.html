<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Chrona Player</title>
  <link rel="icon" href="favicon.ico" type="image/png" crossorigin="anonymous" sizes="32x32">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@600&display=swap">
  <style>
    * {
      box-sizing: border-box;
    }
    *::-webkit-scrollbar {
  width: 7px;
  height: 7px;
}

*::-webkit-scrollbar-track {
  background: rgba(0,0,0,0.2);
  border-radius: 10px;
  backdrop-filter: blur(5px);
 cursor:auto;
}

*::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.692); 
  border-radius: 10px;
  backdrop-filter: blur(5px);
  cursor:auto;
}

*::-webkit-scrollbar-thumb:hover {
  background: rgba(255,255,255,0.3);
}

*::-webkit-scrollbar-button {
  display: none;
  width: 0;
  height: 0;
}

*::-webkit-scrollbar-corner {
  background: transparent;
}

    body, html {
      margin: 0; padding: 0; height: 100%;
      background: #121212;
      font-family: 'Roboto', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #ddd;
      user-select: none;
      overflow: hidden;
    }
    
    #browser-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      width: 100vw;
      overflow: hidden;
      background: #121212;
    }

    #dropzone {
      position: fixed;
      inset: 0;
      border: 2px dashed #444;
      background: #181818;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      transition: border-color 0.3s ease, background 0.3s ease;
      z-index: 100;
      color: #666;
      font-weight: 500;
      font-size: 1.2rem;
    }
    #dropzone.dragover {
      border-color: #888;
      background: #222;
      color: #aaa;
    }
    #dropzone p {
      margin: 0.5rem 0 0 0;
    }
    #dropzone svg {
      width: 60px;
      height: 60px;
      fill: #555;
      margin-bottom: 10px;
    }
    input[type="file"] {
      display: none;
    }

    #player-container {
      position: fixed;
      inset: 0;
      background: #121212;
      display: none;
      justify-content: center;
      align-items: center;
      padding: 1rem;
      z-index: 200; 
    }
    #player-box {
      background: rgba(30,30,30,0.85);
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.9);
      max-width: 90vw;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      user-select: none;
      overflow: hidden;
      position: relative;
      border: 1px solid rgba(255,255,255,0.05);
      backdrop-filter: blur(12px);
      transition: max-height 0.3s ease;
    }

    #player-container.fullscreen {
      max-width: none;
      max-height: none;
      width: 100vw;
      height: 100vh;
      padding: 0;
      background: #000;
    }
    #player-container.fullscreen #player-box {
      width: 100%;
      height: 100%;
      max-width: none;
      max-height: none;
      border-radius: 0;
      box-shadow: none;
      border: none;
      display: flex;
      flex-direction: column;
      position: relative;
      background: rgba(15,15,15,0.9);
      backdrop-filter: blur(14px);
    }
    #player-container.fullscreen video {
      width: 100%;
      height: 100%;
      border-radius: 0;
      object-fit: contain;
      background: #000;
      max-height: none;
    }

    video {
      width: 100%;
      max-height: 70vh;
      border-radius: 12px 12px 0 0;
      background: #000;
      outline: none;
      object-fit: contain;
      transition: max-height 0.3s ease;
    }

    #controls {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 16px;
      background: rgba(20,20,20,0.85);
      font-variant-numeric: tabular-nums;
      font-weight: 500;
      font-size: 1rem;
      color: #ccc;
      user-select: none;
      gap: 12px;
      position: relative;
      transition: opacity 0.3s ease;
      z-index: 10;
      border-top: 1px solid rgba(255,255,255,0.05);
      backdrop-filter: blur(10px);
      box-shadow: inset 0 1px 4px rgba(0,0,0,0.4);
    }
    #player-container.fullscreen #controls {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(20,20,20,0.6);
    border-radius: 10px;
    box-shadow: 0 0 15px rgba(0,0,0,0.6);
    border-bottom-left-radius: 0;
    border-bottom-right-radius: 0;}
    #controls.hide {
      opacity: 0;
      pointer-events: none;
    }

    #time-passed, #time-left {
      width: 60px;
      text-align: center;
      font-family: monospace;
      color: #aaa;
      user-select:none;
      display: flex;
      flex-direction: column;
      justify-content: center;
      line-height: 1.2;
      position: relative;
    }

    #time-left-text {
      white-space: nowrap;
    }

    #finish-time {
      font-size: 0.7rem;
      color: #666;
      font-weight: 400;
      margin-top: 4px;
      white-space: nowrap;
      user-select:none;
      font-family: monospace;
      text-align: center;
      line-height: 1.1;
    }

    #seek-bar {
  -webkit-appearance: none;
  appearance: none;
  width: 100%;
  height: 6px;
  border-radius: 3px;
  background: linear-gradient(
    to right,
    #2196f3 0%,
    #2196f3 var(--seek-percent, 0%),
    rgba(100, 100, 100, 0.3) var(--seek-percent, 0%),
    rgba(100, 100, 100, 0.3) 100%
  );
  cursor: pointer;
  outline: none;
  box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.5);
  user-select: none;
  transition: background 0.3s ease;
}

#seek-bar::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 0;
  height: 0;
  background: transparent;
  cursor: pointer;
  margin-top: 0;
}

#seek-bar::-moz-range-thumb {
  width: 0;
  height: 0;
  background: transparent;
  cursor: pointer;
}

    #fullscreen-btn {
    background: transparent;
    border: none;
    color: #bbb;
    font-size: 1.4rem;
    cursor: pointer;
    user-select: none;
    outline: none;
    padding: 3px 8px;
    border-radius: 6px;
    transition: background 0.3s ease;
    flex-shrink: 0;
    filter: drop-shadow(0 0 1px rgba(0,0,0,0.9));
    transform: translate3d(15px, -10px, 0px);    }
    #fullscreen-btn:hover {
      background: rgba(255,255,255,0.15);
      color: #eee;
    }

    #snap-popup {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(30,30,30,0.8);
      color: #ddd;
      font-weight: 600;
      font-size: 1.6rem;
      padding: 8px 18px;
      border-radius: 12px;
      opacity: 0;
      pointer-events: none;
      user-select: none;
      transition: opacity 0.25s ease;
      font-family: monospace;
      white-space: nowrap;
      box-shadow: 0 0 20px rgba(0,0,0,0.6);
      z-index: 100;
    }
    #snap-popup.show {
      opacity: 1;
      pointer-events: auto;
    }

    #seek-popup {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(30,30,30,0.75);
      color: #ddd;
      font-weight: 600;
      font-size: 1.6rem;
      padding: 6px 16px;
      border-radius: 12px;
      display: none;
      pointer-events: none;
      user-select: none;
      transition: opacity 0.25s ease;
      font-family: monospace;
      white-space: nowrap;
      box-shadow: 0 0 18px rgba(0,0,0,0.5);
      z-index: 101;
      opacity: 0;
    }
    #seek-popup.show-left {
      display: block;
      opacity: 1;
      left: 8%;
      pointer-events: auto;
      transform: translate(-50%, -50%);
    }
    #seek-popup.show-right {
      display: block;
      opacity: 1;
      right: 8%;
      pointer-events: auto;
      transform: translate(50%, -50%);
    }

    #title-popup {
      position: fixed;
      background: rgba(25, 25, 25, 0.98);
      color: #fff;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 0.9rem;
      max-width: 300px;
      z-index: 500;
      pointer-events: none;
      box-shadow: 0 4px 15px rgba(0,0,0,0.8);
      border: 1px solid #444;
      display: none;
      white-space: pre-wrap;
      word-break: break-word;
      line-height: 1.3;
    }

    #toolbar {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin: 1rem 2rem;
      flex-wrap: wrap;
      flex-shrink: 0;
      justify-content: space-between; 
      background: #1c1c1c;
      padding: 8px 12px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      border: 1px solid #333;
    }
    
    .nav-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: nowrap;
    }
    
    .tools-group {
        display: flex;
        align-items: center;
        gap: 0.8rem;
        flex-wrap: nowrap; 
    }
    
    .speed-control-container {
        display: flex;
        align-items: center;
        gap: 8px;
        background: #252525;
        padding: 0 12px;
        border-radius: 6px; 
        border: 1px solid #333;
        box-shadow: inset 0 1px 2px rgba(0,0,0,0.5);
        height: 36px; 
    }
    
    .speed-label {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #888;
        font-weight: 600;
        margin-right: 4px;
        white-space: nowrap;
    }
    
    #folderSpeedRange {
        width: 100px;
        height: 4px;
        background: #444;
        border-radius: 2px;
        appearance: none;
        outline: none;
        cursor: pointer;
        margin: 0;
        padding: 0;
        vertical-align: middle;
    }
    
    #folderSpeedRange::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 14px;
        height: 14px;
        background: #ddd;
        border-radius: 50%;
        cursor: pointer;
        transition: transform 0.1s;
        box-shadow: 0 1px 3px rgba(0,0,0,0.5);
        margin-top: 0;
    }
    
    #folderSpeedRange::-webkit-slider-thumb:hover {
        transform: scale(1.1);
        background: #fff;
    }

    #folderSpeedRange::-moz-range-thumb {
        width: 14px;
        height: 14px;
        background: #ddd;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        transition: transform 0.1s;
        box-shadow: 0 1px 3px rgba(0,0,0,0.5);
    }

    #folderSpeedRange::-moz-range-thumb:hover {
        transform: scale(1.1);
        background: #fff;
    }
    
    #folderSpeedDisplay {
        font-size: 0.85rem;
        color: #ddd;
        font-family: monospace;
        min-width: 35px;
        text-align: right;
        font-weight: 600;
    }
    
    .time-stat-container {
        background: #252525;
        padding: 0 12px;
        border-radius: 6px;
        border: 1px solid #333;
        height: 36px;
        display: flex;
        align-items: center;
        white-space: nowrap;
    }
    
    .time-stat {
        font-size: 0.85rem;
        color: #aaa;
        font-family: monospace;
        font-weight: 600;
    }

    .menu-container {
        position: relative;
        display: inline-block;
    }
    
    .menu-btn {
        width: 36px;
        height: 36px;
        padding: 0 !important;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #2e2e2e;
        border: 1px solid #444;
        border-radius: 6px;
        color: #ddd;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .menu-btn:hover {
        background-color: #3a3a3a;
        color: #fff;
    }

    .dropdown-content {
        display: none;
        position: absolute;
        right: 0;
        top: 110%;
        background-color: #252525;
        min-width: 200px;
        box-shadow: 0 8px 16px rgba(0,0,0,0.6);
        border-radius: 8px;
        border: 1px solid #333;
        z-index: 300;
        overflow: hidden;
        animation: fadeIn 0.2s;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-5px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .dropdown-content.show {
        display: block;
    }

    .dropdown-item {
        color: #ddd;
        padding: 12px 16px;
        text-decoration: none;
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: none;
        border: none;
        width: 100%;
        text-align: left;
        cursor: pointer;
        font-size: 0.95rem;
        transition: background 0.2s;
    }

    .dropdown-item:hover {
        background-color: #333;
    }
    
    .delete-item {
        color: #ff6b6b;
        border-top: 1px solid #333;
    }
    
    .delete-item:hover {
        background-color: #3a2525;
    }

    .modal {
        display: none; 
        position: fixed; 
        z-index: 1000; 
        left: 0;
        top: 0;
        width: 100%; 
        height: 100%; 
        overflow: hidden; 
        background-color: rgba(0,0,0,0.8); 
        backdrop-filter: blur(5px);
        animation: fadeIn 0.3s;
    }

    .modal-content {
        background-color: #1e1e1e;
        margin: 0; 
        padding: 20px;
        border: 1px solid #333;
        width: 90%; 
        max-width: 800px;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.9);
        color: #eee;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        max-height: 90vh;
        display: flex;
        flex-direction: column;
    }
    
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        border-bottom: 1px solid #333;
        padding-bottom: 10px;
        flex-shrink: 0;
    }
    
    .modal-header h2 {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 500;
    }

    .close-modal {
        color: #aaa;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        transition: color 0.2s;
    }

    .close-modal:hover,
    .close-modal:focus {
        color: #fff;
        text-decoration: none;
        cursor: pointer;
    }

    .chart-container {
        position: relative;
        flex: 1;
        width: 100%;
        margin-bottom: 20px;
        overflow: hidden;
    }
    
    #progressChart {
        width: 100%;
        height: 100%;
    }
    
    .chart-nav {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 20px;
        margin-top: 10px;
        flex-shrink: 0;
    }
    
    #chartRangeLabel {
        font-family: monospace;
        color: #bbb;
        font-size: 1rem;
        min-width: 200px;
        text-align: center;
    }


    button.nav-btn, button#pickBtn {
      background-color: #2e2e2e;
      border: 1px solid #444;
      padding: 0 1rem;
      font-size: 0.95rem;
      border-radius: 6px;
      color: #ddd;
      cursor: pointer;
      transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s;
      user-select: none;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 36px;
      white-space: nowrap;
    }
    
    button.nav-btn:disabled {
      color: #555;
      cursor: default;
      border-color: #2a2a2a;
      background-color: #222;
    }
    
    button.nav-btn:not(:disabled):hover,
    button#pickBtn:hover,
    button#pickBtn:focus {
      background-color: #3a3a3a;
      border-color: #666;
      color: #fff;
      outline: none;
    }

    #breadcrumb {
      font-size: 0.9rem;
      color: #999;
      flex-grow: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      user-select: text;
      margin: 0 15px;
      font-weight: 500;
    }
    #breadcrumb span {
      cursor: pointer;
      user-select: none;
      color: #bbb;
      transition: color 0.2s;
    }
    #breadcrumb span:hover {
      text-decoration: underline;
      color: #fff;
    }

    #fileGrid {
      flex-grow: 1; 
      overflow-y: auto; 
      margin: 0 1rem 1rem 1rem;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 1rem;
      background: #1c1c1c;
      border-radius: 8px;
      padding: 1rem;
      user-select: none;
      align-content: start; 
    }

    .card {
      background: #252525;
      border-radius: 8px;
      padding: 0.8rem 0.6rem 1rem 0.6rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      cursor: default;
      user-select: none;
      min-height: 130px;
      max-height: 130px;
      position: relative;
      transition: transform 0.1s;
    }
    .card.clickable {
      cursor: pointer;
    }
    .card:hover {
      box-shadow: inset 0 0 0 1000px rgba(255,255,255,0.05);
    }
    
    .card.last-played {
      box-shadow: 0 0 0 2px #555;
    }
    .card.last-played:hover {
      box-shadow: 0 0 0 2px #777, inset 0 0 0 1000px rgba(255,255,255,0.05);
    }

    .name {
      font-weight: 600;
      font-size: 0.6rem;
      color: #ddd;
      text-align: center;
      display: -webkit-box;
      line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: normal;  
      word-break: normal;   
      width: 100%;
      user-select: text;
    }

    .play-icon {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 25px;
      height: 25px;
      background: rgb(72 72 72);
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      pointer-events: none;
      fill: #fff;
      z-index: 15;
      transform: translate(-50%, -50%);
    }
    .play-icon svg {
      width: 15px;
      height: 15px;
      margin-left: 0;
    }

    .folder-thumb {
      position: relative;
      width: 54px;
      height: 54px;
      background: #2a2a2a;
      border-radius: 8px;
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      grid-template-rows: repeat(2, 1fr);
      gap: 2px;
      padding: 4px;
      box-sizing: border-box;
      user-select: none;
    }

    .folder-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 4px;
    }

    .folder-icon-overlay {
      position: absolute;
      width: 60px;
      height: 60px;
      bottom: -5px;
      right: -2.5px;
      fill: #777;
      background: transparent;
      pointer-events: none;
      z-index: 10;
    }

    .plain-folder-icon {
      width: 60px;
      height: 60px;
      fill: #777;
      background: transparent;
      pointer-events: none;
      user-select: none;
      flex-shrink: 0;
    }

    .thumb-img {
      width: 100%;
      border-radius: 8px;
      object-fit: cover;
      flex-shrink: 0;
      position: relative;
      max-height: 70px;
      min-height: 70px; 
      background: #1a1a1a; 
    }
    .thumb-img-wrapper {
      position: relative;
      display: inline-block;
      width: 100%; 
      height: 70px;
      margin-bottom: 5px;
    }


    .file-icon {
      position: absolute;
      bottom: -5px;
      right: -2.5px;
      width: 60px;
      height: 60px;
      background: transparent;
      fill: #6c6c6c;
      user-select: none;
      flex-shrink: 0;
      z-index: 10;
    }

    .no-data {
      grid-column: 1 / -1;
      color: #666;
      text-align: center;
      user-select: none;
      padding: 2rem 0;
      font-style: italic;
    }

    #footer {
      margin: 0 2rem 1rem 2rem;
      font-size: 0.85rem;
      color: #555;
      user-select: text;
      text-align: center;
      font-style: italic;
    }

      label {
    font-size: 1.2rem;
    user-select: none;
    position: absolute;
    bottom: 15px;
    right: 20px;
    z-index: 150;
  }
  .switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 26px;
  }
  .switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }
  .slider {
    background-color: #555;
    position: absolute;
    cursor: pointer;
    top: 0; left: 0; right: 0; bottom: 0;
    transition: 0.4s;
    border-radius: 13px;
  }
  .slider:before {
    position: absolute;
    content: "";
    height: 22px;
    width: 22px;
    left: 2px;
    bottom: 2px;
    background-color: #222;
    transition: 0.4s;
    border-radius: 50%;
  }
  input:checked + .slider {

    background-color: #606060;  }
  input:checked + .slider:before {
    transform: translateX(24px);
    background-color: #cfcfcf;  }
      
    
.browse-button {
       cursor: pointer;
    user-select: none;
    background: linear-gradient(145deg, #222, #121212);
    border: 1.5px solid #444;
    box-shadow: inset 0 1px 0 rgba(255,255,255,0.1),
      0 2px 5px rgba(0,0,0,0.7);
    padding: 8px 20px;
    margin-left: 10px;
    color: #eee;
    font-weight: 600;
    font-size: 15px;
    border-radius: 6px;
    transition: background 0.25s ease, box-shadow 0.25s ease;
    z-index: 101;
    position: absolute;
    bottom: 30%;
    left: 50%;
    transform: translateX(-50%);
  }

  .browse-button:hover {
    background: linear-gradient(145deg, #333, #1a1a1a);
    box-shadow:
      inset 0 1px 0 rgba(255,255,255,0.3),
      0 4px 10px rgba(0,0,0,0.9);
  }
  
  #settings-bar {
    padding: 10px 2rem;
    flex-shrink: 0;
    display: flex;
    justify-content: flex-end;
  }
  
  #daily-stats {
    position: fixed;
    bottom: 20px;
    left: 20px;
    background: rgba(0, 0, 0, 0.6);
    padding: 5px 10px;
    border-radius: 4px;
    font-size: 0.9rem;
    color: #aaa;
    pointer-events: none;
    z-index: 205; 
    display: none; 
    font-family: monospace;
    border: 1px solid rgba(255,255,255,0.1);
  }

    @property --angle {
        syntax: '<angle>';
        initial-value: 0deg;
        inherits: false;
    }
#loader-overlay {
    position: fixed;
    inset: 0;
    z-index: 9999;
    background: #000000;
    display: flex;
    justify-content: center;
    align-items: center;
    color: #eafcff;
    font-family: 'Poppins', sans-serif;
}

#loader-overlay.dismissing {
    animation: fadeOutBg 100ms ease-out forwards 100ms;
    pointer-events: none;
}

#loader-overlay.dismissing .l-stage {
    animation: snapDown 100ms forwards;
}

@keyframes fadeOutBg {
    to { opacity: 0; }
}

@keyframes snapDown {
    0% { transform: translateY(0); animation-timing-function: cubic-bezier(0.6, 0.04, 0.98, 0.335); }
    100% { transform: translateY(120vh); }
}

.l-stage {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    position: relative;
    width: 100%;
}

@keyframes bounceWait {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}
#loader-overlay.bouncing .l-stage {
    animation: bounceWait 500ms infinite ease-in-out !important;
}

#loader-overlay.fast-mode * {
    animation-duration: 0s !important;
    animation-delay: 0s !important;
}

.l-play-button-wrapper {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(1);
    z-index: 10;
    animation: playButtonMove 1s cubic-bezier(0.68, -0.6, 0.32, 1.6) forwards;
}

.l-play-btn {
    width: 45px;
    height: 45px;
    border-radius: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: transform 0.2s;
    animation: playBGMove 1s cubic-bezier(0.68, -0.6, 0.32, 1.6) forwards;
    backdrop-filter: blur(6px);
}

.l-play-btn:hover { transform: scale(1.05); }

.l-play-icon {
    width: 0;
    height: 0;
    margin-left: 5px;
    border-top: 14px solid transparent;
    border-bottom: 14px solid transparent;
    border-left: 24px solid white;
    transform: scale(0);
    animation: popPlayIcon 1.1s cubic-bezier(0.68, -0.6, 0.32, 1.6) forwards;
    filter: drop-shadow(0 4px 10px rgba(0,0,0,0.35));
    background: transparent;
    border-radius: 0;
}

.l-logo-row {
    display: flex;
    align-items: center;
    justify-content: center;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 20;
    animation: moveLogoDown 1s cubic-bezier(0.68, -0.6, 0.32, 1.6) forwards;
}

.l-c-container {
    position: relative;
    width: 80px;
    height: 80px;
    flex-shrink: 0;
    animation: orientC 0.8s cubic-bezier(0.68, -0.6, 0.32, 1.6) forwards;
}

.l-ring {
    position: absolute;
    inset: 0;
    border-radius: 50%;
    background: conic-gradient(from 0deg, #a3b2b8 0deg, #ff4e4e 270deg, #00d6ff 360deg);
    -webkit-mask-image: radial-gradient(transparent 44%, black 46%), conic-gradient(black var(--angle), transparent var(--angle));
    mask-image: radial-gradient(transparent 44%, black 46%), conic-gradient(black var(--angle), transparent var(--angle));
    -webkit-mask-composite: source-in;
    mask-composite: intersect;
    transform: scaleX(-1);
    animation: fillRing 1s cubic-bezier(0.68, -0.6, 0.32, 1.6) forwards;
    box-shadow: inset 0 2px 12px rgba(255,255,255,0.02);
    filter: drop-shadow(0 4px 15px rgba(0, 214, 255, 0.3));
}

.l-dot-wrapper {
    position: absolute;
    inset: 0;
    pointer-events: none;
    z-index: 60;
    animation: rotateDotWrapper 1s cubic-bezier(0.68, -0.6, 0.32, 1.6) forwards;
}

.l-dot {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 26px;
    height: 26px;
    background: #00d6ff;
    border-radius: 50%;
    box-shadow: 0 0 12px rgba(0, 229, 255, 0.28);
    transform: translate(-50%, -50%) translateY(-40px);
    animation: moveDotToO 1s cubic-bezier(0.68, -0.6, 0.32, 1.6) forwards;
    border: 1px solid rgba(255,255,255,0.06);
}

.l-text-part {
    display: flex;
    align-items: baseline;
    position: relative;
    z-index: 40;
    font-size: 2.5rem;
    font-weight: 600;
    line-height: 1;
    white-space: nowrap;
    margin-left: 0;
    animation: revealText 1s cubic-bezier(0.68, -0.6, 0.32, 1.6) forwards;
    opacity: 0;
    max-width: 0;
    overflow: hidden;
    padding: 20px 20px 30px 0;
    margin: -20px -20px -30px 0;
    color: #eafcff;
    text-shadow: 0 6px 18px rgba(2,10,20,0.6);
}

.l-spacer-o { display: inline-block; width: 25px; }

.l-sub-text {
    color:#cfeeff;
    font-size: 1.6rem;
    margin-left: 10px;
    font-weight: 400;
    opacity: 0.95;
}

.l-clock-container {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 30px;
    height: 30px;
    border: 2px solid rgba(174,246,255,0.9);
    border-radius: 50%;
    animation: fadeOutClock 1s cubic-bezier(0.68, -0.6, 0.32, 1.6) forwards;
    background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
    box-shadow: 0 6px 18px rgba(0, 214, 255, 0.04), inset 0 1px 4px rgba(255,255,255,0.02);
}

.l-hand {
    position: absolute;
    bottom: 50%;
    left: 50%;
    background: #eafcff;
    transform-origin: bottom center;
    border-radius: 2px;
}
.l-hand-h {
    width: 2px;
    height: 8px;
    transform: translateX(-50%) rotate(45deg);
}
.l-hand-m {
    width: 2px;
    height: 11px;
    animation: spinHand 1s cubic-bezier(0.68, -0.6, 0.32, 1.6) forwards;
}

@keyframes fillRing {
    0% { --angle: 0deg; }
    40% { --angle: 270deg; }
    100% { --angle: 270deg; opacity: 1; background: conic-gradient(from 0deg, #b9dfff 0deg, #a61d18 270deg, #00d6ff 360deg); }
}

@keyframes rotateDotWrapper {
    0% { transform: rotate(0deg); }
    40% { transform: rotate(-270deg); }
    100% { transform: rotate(-270deg); }
}

@keyframes moveDotToO {
    0%, 55% {
        transform: translate(-110%, 0%) translateY(-40px);
        background: linear-gradient(135deg, #00d6ff, #5eead4);
        width: 15px; height: 15px;
        box-shadow: none;
    }
    70% {
        transform: translate(-50%, -50%) rotate(225deg) translate(75px, 4px);
        background: #00d6ff;
        width: 25px; height: 25px;
        box-shadow: 0 0 12px rgba(0,229,255,0.28);
    }
    100% {
        transform: translate(-50%, -50%) rotate(225deg) translate(75px, 4px);
        opacity: 1;
        background: #00d6ff;
        width: 25px; height: 25px;
    }
}

@keyframes spinHand {
    0% { transform: translateX(-50%) rotate(0deg); }
    40% { transform: translateX(-50%) rotate(-360deg); }
    100% { transform: translateX(-50%) rotate(-360deg); }
}

@keyframes fadeOutClock {
    0%, 45% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    55% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
    100% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
}

@keyframes playButtonMove {
    0%, 45% { transform: translate(-50%, -50%) scale(1); top: 50%; }
    60% { transform: translate(-50%, -50%) scale(1.1); top: 20%; }
    75% { transform: translate(-165%, -50%) scale(0.95); top: 20%; }
    100% { transform: translate(-165%, -50%) scale(1); top: 20%; }
}

@keyframes playBGMove {
    0%, 45% { width: 45px;height: 45px; }
    60% { width: 80px;height: 80px; }
    75% { width: 75px;height: 75px; }
    100% { width: 75px;height: 75px; }
}

@keyframes popPlayIcon {
    0%, 65% { transform: scale(0); }
    75% { transform: scale(1.3); }
    85% { transform: scale(0.9); }
    100% { transform: scale(1); }
}

@keyframes moveLogoDown {
    0%, 45% { top: 50%; transform: translate(-50%, -50%) scale(1); }
    60% { top: 65%; transform: translate(-50%, -50%) scale(0.9); }
    100% { top: 65%; transform: translate(-50%, -50%) scale(0.9); opacity: 1; }
}

@keyframes orientC {
    0%, 45% { transform: rotate(0deg); }
    60% { transform: rotate(45deg); }
    100% { transform: rotate(45deg); }
}

@keyframes revealText {
    0%, 60% { opacity: 0; max-width: 0; margin-left: 0; }
    75% { opacity: 1; max-width: 400px; margin-left: -20px; }
    100% { opacity: 1; max-width: 400px; margin-left: -20px; }
}

@media (max-width:420px){
    .l-text-part{font-size:1.6rem}
    .l-sub-text{font-size:1rem}
    .l-c-container{width:64px;height:64px}
}
  </style>
</head>
<body>
  <div id="loader-overlay">
      <div class="l-stage">
          <div class="l-play-button-wrapper">
              <div class="l-play-btn">
                  <div class="l-play-icon"></div>
              </div>
          </div>
          <div class="l-logo-row">
              <div class="l-c-container">
                  <div class="l-ring"></div>
                  <div class="l-dot-wrapper">
                      <div class="l-dot"></div>
                  </div>
                  <div class="l-clock-container">
                      <div class="l-hand l-hand-h"></div>
                      <div class="l-hand l-hand-m"></div>
                  </div>
              </div>
              <div class="l-text-part">
                  <span>hr</span>
                  <span class="l-spacer-o"></span>
                  <span>na</span>
                  <span class="l-sub-text">Player</span>
              </div>
          </div>
        </div>
  </div>
      <div id="wastedtimewarn"></div>
  <div id="dropzone" tabindex="0" aria-label="Video file drop zone. Click or drag video file here to play.">
    <svg viewBox="0 0 24 24" aria-hidden="true" >
      <path d="M5 20h14v-2H5v2zm7-18L5.33 9.67l1.41 1.41L11 7.83v10.17h2V7.83l4.26 3.25 1.41-1.41L12 2z"/>
    </svg>
    <p>Click or drag & drop video here</p>
    <input type="file" accept="video/*, .mkv, .mp4, .webm" id="file-input" />    
  </div>
        <button class="browse-button" id="browseropen" onclick="openbrowse();" >Browse Video Gallery</button>

<div id="browser-container">
<br>

<div id="toolbar" role="region" aria-label="Folder selection toolbar">
  <div class="nav-group">
    <button id="backBtn" class="nav-btn" aria-label="Go back" disabled>&larr;</button>
    <button id="homeBtn" class="nav-btn" aria-label="Go home">&#8962;</button>
    <button id="forwardBtn" class="nav-btn" aria-label="Go forward" disabled> &rarr;</button>
    <button id="pickBtn" aria-label="Pick videos folder">Select Videos Folder</button>
  </div>
  
  <nav id="breadcrumb" aria-label="Breadcrumb navigation"></nav>

  <div class="tools-group">
    <div class="time-stat-container">
      <span id="folderTotalTime" class="time-stat"></span>
    </div>

    <div class="speed-control-container">
      <div class="speed-label">Speed</div>
      <input type="range" id="folderSpeedRange" min="0.5" max="4.0" step="0.1" value="1.0">
      <div id="folderSpeedDisplay">1x</div>
    </div>
    
    <div class="menu-container">
      <button id="menuBtn" class="nav-btn menu-btn" title="More Options">
        <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
          <path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
        </svg>
      </button>
      <div id="dropdownMenu" class="dropdown-content">
        <button id="viewProgressBtn" class="dropdown-item">View My Progress</button>
        <button id="deleteProgressBtn" class="dropdown-item delete-item">
          <span>Delete Progress</span>
          <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"></path></svg>
        </button>
      </div>
    </div>

  </div>
</div>

<div id="fileGrid" aria-live="polite" aria-label="Files and folders grid">
  <div class="no-data">No folder selected or permission denied.</div>
</div>

<div id="settings-bar">
<label style="position: relative; bottom: auto; right: auto;">
  Open browse section by default
  <div class="switch">
    <input type="checkbox" id="browseToggle" />
    <span class="slider"></span>
  </div>
</label>
</div>

</div>

  <div id="player-container" aria-label="Video player container">
    <div id="player-box" role="region" aria-label="Video player">
      <video id="video" tabindex="0" playsinline></video>
      <div id="snap-popup" role="alert" aria-live="assertive"></div>
      <div id="seek-popup" role="alert" aria-live="assertive"></div>
      <div id="controls" aria-live="polite" aria-atomic="true">
        <span id="time-passed" aria-label="Time passed">0:00</span>
        <input type="range" id="seek-bar" min="0" max="100" value="0" step="0.1" aria-label="Seek video timeline" />
        <span id="time-left" aria-label="Time left">
          <div id="time-left-text">-0:00</div>
          <div id="finish-time" aria-live="polite" aria-atomic="true"></div>
        </span>
        <button id="fullscreen-btn" aria-label="Toggle fullscreen" title="Fullscreen (f)">⛶</button>
      </div>
    </div>
  </div>

  <div id="title-popup"></div>
  <div id="daily-stats">Today: 0h 00m 00s</div>
  <div id="progressModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>My Progress</h2>
        <span class="close-modal">&times;</span>
      </div>
      <div class="chart-container">
      <canvas id="progressChart"></canvas>
      </div>
      <div class="chart-nav">
        <button id="chartPrevBtn" class="nav-btn">&larr; Previous</button>
        <span id="chartRangeLabel"></span>
        <button id="chartNextBtn" class="nav-btn">Next &rarr;</button>
      </div>
    </div>
  </div>
<script>
  function openbrowse(){
  document.getElementById('dropzone').style.display = "none";
  document.getElementById('browseropen').style.display = "none";
  const ds = document.getElementById('daily-stats');
  if(ds) ds.style.display = 'block';
 }
(() => {
  const dropzone = document.getElementById('dropzone');
  const fileInput = document.getElementById('file-input');
  const playerContainer = document.getElementById('player-container');
  const playerBox = document.getElementById('player-box');
  const video = document.getElementById('video');
  const timePassedEl = document.getElementById('time-passed');
  const timeLeftTextEl = document.getElementById('time-left-text');
  const finishTimeEl = document.getElementById('finish-time');
  const seekBar = document.getElementById('seek-bar');
  const snapPopup = document.getElementById('snap-popup');
  const seekPopup = document.getElementById('seek-popup');
  const fullscreenBtn = document.getElementById('fullscreen-btn');
  const titlePopup = document.getElementById('title-popup');
  const folderSpeedRange = document.getElementById('folderSpeedRange');
  const folderSpeedDisplay = document.getElementById('folderSpeedDisplay');
  const folderTotalTime = document.getElementById('folderTotalTime');
  const dailyStatsEl = document.getElementById('daily-stats');
  const menuBtn = document.getElementById('menuBtn');
  const dropdownMenu = document.getElementById('dropdownMenu');
  const viewProgressBtn = document.getElementById('viewProgressBtn');
  const deleteProgressBtn = document.getElementById('deleteProgressBtn');
  const progressModal = document.getElementById('progressModal');
  const closeModal = document.querySelector('.close-modal');
  const progressChart = document.getElementById('progressChart');
  const chartPrevBtn = document.getElementById('chartPrevBtn');
  const chartNextBtn = document.getElementById('chartNextBtn');
  const chartRangeLabel = document.getElementById('chartRangeLabel');
  
  let playbackRate = 1;
  let snapTimeout = null;
  let currentFileName = null;
  let currentFileSize = null;
  let currentFileLastModified = null;
  let seeking = false;
  let seekPopupTimeout = null;
  let controlsHideTimer = null;
  let lastSaveTime = -1;
  
  let currentViewFiles = [];   let thumbnailQueue = [];   let isProcessingQueue = false;
  let dailyAccumulator = 0;
  function getTodayKey() {
    const now = new Date();
    if (now.getHours() < 4) {
      now.setDate(now.getDate() - 1);
    }
    return now.toDateString();
  }
  
  function updateDailyStatsDisplay() {
    if(!dailyStatsEl) return;
    const todayKey = getTodayKey();
    const stored = JSON.parse(localStorage.getItem('todayspent') || '{}');
    const count = stored[todayKey] || 0;
    const totalSeconds = count * 15;
    
    const h = Math.floor(totalSeconds / 3600);
    const m = Math.floor((totalSeconds % 3600) / 60);
    const s = totalSeconds % 60;
    dailyStatsEl.textContent = `Today: ${h}h ${m < 10 ? '0'+m : m}m ${s < 10 ? '0'+s : s}s`;
  }
  
  function incrementDailyStats() {
    const todayKey = getTodayKey();
    const stored = JSON.parse(localStorage.getItem('todayspent') || '{}');
    if (!stored[todayKey]) stored[todayKey] = 0;
    stored[todayKey]++;
    localStorage.setItem('todayspent', JSON.stringify(stored));
    updateDailyStatsDisplay();
  }
  setInterval(() => {
    if (video && !video.paused && !video.ended && video.readyState > 2) {
      dailyAccumulator++;
      if (dailyAccumulator >= 15) {
        incrementDailyStats();
        dailyAccumulator = 0;
      }
    }
  }, 1000);
  updateDailyStatsDisplay();
  menuBtn.onclick = (e) => {
    e.stopPropagation();
    dropdownMenu.classList.toggle('show');
  };

  document.addEventListener('click', (e) => {
    if (!menuBtn.contains(e.target) && !dropdownMenu.contains(e.target)) {
      dropdownMenu.classList.remove('show');
    }
  });

  let chartOffset = 0;
  
  function getChartDateKey(date) {
    return date.toDateString();
  }
  
  function renderChart() {
    if (!progressChart) return;
    const ctx = progressChart.getContext('2d');
    const dpr = 2; 
    const rect = progressChart.getBoundingClientRect();
    progressChart.width = rect.width * dpr;
    progressChart.height = rect.height * dpr;
    ctx.scale(dpr, dpr);
    const width = rect.width;
    const height = rect.height;
    ctx.clearRect(0, 0, width, height);
    ctx.fillStyle = '#1e1e1e';
    ctx.fillRect(0,0,width, height);
    
    const stored = JSON.parse(localStorage.getItem('todayspent') || '{}');
    const daysToShow = 15;
    const today = new Date();
    if (today.getHours() < 4) today.setDate(today.getDate() - 1);
    const endDate = new Date(today);
    endDate.setDate(endDate.getDate() - (chartOffset * daysToShow));
    
    const startDate = new Date(endDate);
    startDate.setDate(startDate.getDate() - (daysToShow - 1));
    const options = { month: 'short', day: 'numeric' };
    chartRangeLabel.textContent = `${startDate.toLocaleDateString(undefined, options)} - ${endDate.toLocaleDateString(undefined, options)}`;
    const dataPoints = [];
    let maxSeconds = 0;
    
    for (let i = 0; i < daysToShow; i++) {
        const d = new Date(startDate);
        d.setDate(d.getDate() + i);
        const key = getChartDateKey(d);
        const count = stored[key] || 0;
        const seconds = count * 15;
        if (seconds > maxSeconds) maxSeconds = seconds;
        dataPoints.push({ date: d, seconds: seconds });
    }
    if (maxSeconds === 0) maxSeconds = 3600;
    const yMax = Math.ceil(maxSeconds * 1.1);
    const padding = 40;
    const graphWidth = width - padding * 2;
    const graphHeight = height - padding * 2;
    
    ctx.strokeStyle = '#444';
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(padding, padding);
    ctx.lineTo(padding, height - padding);
    ctx.lineTo(width - padding, height - padding);
    ctx.stroke();
    const barWidth = (graphWidth / daysToShow) * 0.6;
    const spacing = (graphWidth / daysToShow);
    
    dataPoints.forEach((pt, index) => {
        const x = padding + (index * spacing) + (spacing - barWidth) / 2;
        const barHeight = (pt.seconds / yMax) * graphHeight;
        const y = height - padding - barHeight;
        const gradient = ctx.createLinearGradient(x, y, x, height - padding);
        gradient.addColorStop(0, '#2196f3');
        gradient.addColorStop(1, '#0d47a1');
        ctx.fillStyle = gradient;
        ctx.fillRect(x, y, barWidth, barHeight);
        ctx.fillStyle = '#aaa';
        ctx.font = '10px monospace';
        ctx.textAlign = 'center';
        const dateStr = pt.date.getDate();
        ctx.fillText(dateStr, x + barWidth/2, height - padding + 15);
        if(pt.seconds > 0) {
            ctx.fillStyle = '#fff';
            let label = '';
            if (pt.seconds >= 3600) label = (pt.seconds / 3600).toFixed(1) + 'h';
            else label = Math.round(pt.seconds / 60) + 'm';
            ctx.fillText(label, x + barWidth/2, y - 5);
        }
    });
  }

  viewProgressBtn.onclick = () => {
      progressModal.style.display = 'block';
      chartOffset = 0;
      renderChart();
      dropdownMenu.classList.remove('show');
  };
  
  closeModal.onclick = () => {
      progressModal.style.display = 'none';
  };
  
  window.onclick = (e) => {
      if (e.target == progressModal) {
          progressModal.style.display = 'none';
      }
  };
  
  chartPrevBtn.onclick = () => {
      chartOffset++;
      renderChart();
  };
  
  chartNextBtn.onclick = () => {
      if (chartOffset > 0) {
          chartOffset--;
          renderChart();
      }
  };
  
  window.addEventListener('resize', renderChart);

  function formatTime(sec) {
    sec = Math.floor(sec);
    const h = Math.floor(sec / 3600);
    const m = Math.floor((sec % 3600) / 60);
    const s = sec % 60;
    if (h > 0) return h + ':' + (m < 10 ? '0'+m : m) + ':' + (s < 10 ? '0'+s : s);
    return m + ':' + (s < 10 ? '0' + s : s);
  }
  
  function formatHoursMinutes(sec) {
     const h = Math.floor(sec / 3600);
     const m = Math.floor((sec % 3600) / 60);
     const s = Math.floor(sec % 60);
     if(h===0 && m===0) return `0m left`;
     if(h===0) return `${m}m left`;
     return `${h}h ${m}m left`;
  }

  function formatAMPM(date) {
    let hours = date.getHours();
    let minutes = date.getMinutes();
    const ampm = hours >= 12 ? 'PM' : 'AM';
    hours = hours % 12;
    if (hours === 0) hours = 12;
    return hours + ':' + (minutes < 10 ? '0'+minutes : minutes) + ' ' + ampm;
  }

  function showSnapPopup(text) {
    snapPopup.textContent = text;
    snapPopup.style.top = '50%';
    snapPopup.style.left = '50%';
    snapPopup.style.transform = 'translate(-50%, -50%)';
    snapPopup.classList.add('show');
    if (snapTimeout) clearTimeout(snapTimeout);
    snapTimeout = setTimeout(() => {
      snapPopup.classList.remove('show');
    }, 1000);
  }

  function showSeekPopup(text, direction) {
    seekPopup.textContent = text;
    if (direction === 'left') {
      seekPopup.classList.add('show-left');
      seekPopup.classList.remove('show-right');
    } else if (direction === 'right') {
      seekPopup.classList.add('show-right');
      seekPopup.classList.remove('show-left');
    }
    if (seekPopupTimeout) clearTimeout(seekPopupTimeout);
    seekPopupTimeout = setTimeout(() => {
      seekPopup.classList.remove('show-left');
      seekPopup.classList.remove('show-right');
    }, 1000);
  }

  function updateTime() {
    if (!video.duration) return;
    const current = video.currentTime;
    const duration = video.duration;
    const left = (duration - current) / playbackRate;

    timePassedEl.textContent = formatTime(current);
    timeLeftTextEl.textContent = '-' + formatTime(left);

    const now = new Date();
    const finishDate = new Date(now.getTime() + left * 1000);
    finishTimeEl.textContent = 'Finishes at ' + formatAMPM(finishDate);

      const percent = (current / duration) * 100;
      seekBar.style.setProperty('--seek-percent', percent + '%');

  }

  function saveProgress() {
    if (!currentFileName) return;
    const data = {
      time: video.currentTime,
      duration: video.duration || 0,
      playbackRate,
      lastModified: currentFileLastModified,
      size: currentFileSize,
      timestamp: Date.now() 
    };
    localStorage.setItem('video-progress-' + currentFileName, JSON.stringify(data));
  }
  
  function saveDuration(file, duration) {
      if(!file) return;
      const key = 'video-progress-' + file.name;
      const existing = localStorage.getItem(key);
      if(existing) {
          try {
             const data = JSON.parse(existing);
             if (!data.duration && duration > 0) {
                 data.duration = duration;
                 localStorage.setItem(key, JSON.stringify(data));
             }
          } catch(e) {}
      } else {
          const data = {
              time: 0,
              duration: duration,
              playbackRate: 1,
              lastModified: file.lastModified,
              size: file.size,
              timestamp: 0 
          };
          localStorage.setItem(key, JSON.stringify(data));
      }
  }

  function loadProgress(fileInfo) {
    if (!fileInfo.name) return null;
    const saved = localStorage.getItem('video-progress-' + fileInfo.name);
    if (!saved) return null;
    try {
      const data = JSON.parse(saved);
      if (data.size === fileInfo.size && data.lastModified === fileInfo.lastModified) {
        return data;
      }
    } catch {
      return null;
    }
    return null;
  }
function handleFile(file) {
  if (!file.type.startsWith('video/') && !file.name.match(/\.(mkv|mp4|webm)$/i)) {
  }
  
  openbrowse();
  if(dailyStatsEl) dailyStatsEl.style.display = 'block';
  
  currentFileName = file.name;
  currentFileSize = file.size;
  currentFileLastModified = file.lastModified;

  const fileURL = URL.createObjectURL(file);
  video.src = fileURL;
  video.playbackRate = playbackRate = 1;
  video.load();

  dropzone.style.display = 'none';
  playerContainer.style.display = 'flex';

  video.focus();

  const progress = loadProgress({
    name: currentFileName,
    size: currentFileSize,
    lastModified: currentFileLastModified
  });

  
  video.addEventListener('loadedmetadata', function onMetadata() {
    video.removeEventListener('loadedmetadata', onMetadata);

    if (progress && progress.time >= 1 && progress.time < video.duration * 0.94) {
      video.currentTime = progress.time;
      playbackRate = progress.playbackRate || 1;
      video.playbackRate = playbackRate;
      if(playbackRate == 1){showSnapPopup(`Resumed from ${formatTime(progress.time)}`);}
      else{showSnapPopup(`Resumed from ${formatTime(progress.time)} @${playbackRate.toFixed(1)}x`);}
    }
    video.play();
  });
}

  video.addEventListener('click', () => {
    if (video.paused) {
      video.play();
      showSnapPopup('⏸');
    } else {
      video.pause();
      showSnapPopup('▶');
    }
  });

  video.addEventListener('timeupdate', () => {
    updateTime();
    const currentSec = Math.floor(video.currentTime);
    if (currentSec !== lastSaveTime) {
      saveProgress();
      lastSaveTime = currentSec;
    }
  });

  document.addEventListener('keydown', (e) => {
    if (playerContainer.style.display === 'none') return;
    if (e.target === seekBar || e.target === fileInput) return;

    const step = 10;
    switch (e.key) {
      case 'ArrowRight':
        video.currentTime = Math.min(video.currentTime + step, video.duration);
        showSeekPopup(`${step}s >`, 'right');
        updateTime();
        break;
      case 'ArrowLeft':
        video.currentTime = Math.max(video.currentTime - step, 0);
        showSeekPopup(`< ${step}s`, 'left');
        updateTime();
        break;
      case 'ArrowUp':
        video.volume = Math.min(video.volume + 0.05, 1);
        showSnapPopup(`Volume: ${Math.round(video.volume * 100)}%`);
        break;
      case 'ArrowDown':
        video.volume = Math.max(video.volume - 0.05, 0);
        showSnapPopup(`Volume: ${Math.round(video.volume * 100)}%`);
        break;
      case ']':
      case '=':
        playbackRate = Math.min(playbackRate + 0.1, 8);
        video.playbackRate = playbackRate;
        showSnapPopup(`Speed: ${playbackRate.toFixed(1)}x`);
        updateTime();
        break;
      case '[':
      case '-':
        playbackRate = Math.max(playbackRate - 0.1, 0.1);
        video.playbackRate = playbackRate;
        showSnapPopup(`Speed: ${playbackRate.toFixed(1)}x`);
        updateTime();
        break;
      case ' ':
        e.preventDefault();
        if (video.paused) {
          video.play();
          showSnapPopup('⏸');
        } else {
          video.pause();
          showSnapPopup('▶');
        }
        break;
      case 'f':
      case 'F':
        toggleFullscreen();
        break;
    }
  });

  seekBar.addEventListener('input', (e) => {
    seeking = true;
    const val = e.target.value;
    const newTime = (val / 100) * video.duration;
    video.currentTime = newTime;
    updateTime();
  });
  seekBar.addEventListener('change', () => {
    seeking = false;
    saveProgress();
  });

  function toggleFullscreen() {
    if (!document.fullscreenElement) {
      if (playerContainer.requestFullscreen) playerContainer.requestFullscreen();
      else if (playerContainer.webkitRequestFullscreen) playerContainer.webkitRequestFullscreen();
    } else {
      if (document.exitFullscreen) document.exitFullscreen();
      else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
    }
  }

  fullscreenBtn.addEventListener('click', toggleFullscreen);

  document.addEventListener('fullscreenchange', () => {
    if (document.fullscreenElement) {
      playerContainer.classList.add('fullscreen');
      if(dailyStatsEl) dailyStatsEl.style.display = 'none';
      startControlsHideTimer();
      document.addEventListener('mousemove', resetControlsHideTimer);
      document.addEventListener('keydown', resetControlsHideTimer);
    } else {
      playerContainer.classList.remove('fullscreen');
      if(dailyStatsEl) dailyStatsEl.style.display = 'block';
      showControls();
      document.removeEventListener('mousemove', resetControlsHideTimer);
      document.removeEventListener('keydown', resetControlsHideTimer);
      clearTimeout(controlsHideTimer);
    }
  });

  function hideControls() {
    document.getElementById('controls').classList.add('hide');
    video.style.cursor = "none";
  }
  function showControls() {
    document.getElementById('controls').classList.remove('hide');
        video.style.cursor = "";

  }
  function startControlsHideTimer() {
    clearTimeout(controlsHideTimer);
    controlsHideTimer = setTimeout(hideControls, 2000);
  }
  function resetControlsHideTimer() {
    showControls();
    startControlsHideTimer();
  }

  dropzone.addEventListener('click', () => fileInput.click());

  dropzone.addEventListener('dragover', e => {
    e.preventDefault();
    dropzone.classList.add('dragover');
  });
  dropzone.addEventListener('dragleave', e => {
    e.preventDefault();
    dropzone.classList.remove('dragover');
  });
  dropzone.addEventListener('drop', e => {
    e.preventDefault();
    dropzone.classList.remove('dragover');
    if (e.dataTransfer.files.length > 0) {
      handleFile(e.dataTransfer.files[0]);
    }
  });

if(localStorage.getItem('browseornot') == 1){openbrowse();}

  fileInput.addEventListener('change', (e) => {
    if (fileInput.files.length > 0) {
      handleFile(fileInput.files[0]);
    }
  });
  const pickBtn = document.getElementById('pickBtn');
  const backBtn = document.getElementById('backBtn');
  const forwardBtn = document.getElementById('forwardBtn');
  const homeBtn = document.getElementById('homeBtn');
  const fileGrid = document.getElementById('fileGrid');
  const breadcrumb = document.getElementById('breadcrumb');
  const toggle = document.getElementById('browseToggle');
  const browseornot = localStorage.getItem('browseornot');

if(!browseornot){localStorage.setItem('browseornot',0);}
  toggle.checked = browseornot === null ? true : browseornot === '1';
  toggle.addEventListener('change', () => {
    localStorage.setItem('browseornot', toggle.checked ? '1' : '0');
  });

  let rootHandle = null;
  let currentHandle = null;
  let pathStack = [];    
  let forwardStack = []; 
  
  function openThumbDB() {
    return new Promise((resolve, reject) => {
      const req = indexedDB.open('thumbDB', 1);
      req.onupgradeneeded = e => {
        e.target.result.createObjectStore('thumbs');
      };
      req.onsuccess = e => resolve(e.target.result);
      req.onerror = e => reject(e.target.error);
    });
  }

  async function saveThumb(key, dataURL) {
    const db = await openThumbDB();
    return new Promise((res, rej) => {
      const tx = db.transaction('thumbs', 'readwrite');
      tx.objectStore('thumbs').put(dataURL, key);
      tx.oncomplete = () => res();
      tx.onerror = e => rej(e.target.error);
    });
  }
  
  async function deleteThumb(key) {
    const db = await openThumbDB();
    return new Promise((res, rej) => {
      const tx = db.transaction('thumbs', 'readwrite');
      tx.objectStore('thumbs').delete(key);
      tx.oncomplete = () => res();
      tx.onerror = e => rej(e.target.error);
    });
  }

  async function getThumb(key) {
    const db = await openThumbDB();
    return new Promise((res, rej) => {
      const tx = db.transaction('thumbs', 'readonly');
      const req = tx.objectStore('thumbs').get(key);
      req.onsuccess = () => res(req.result);
      req.onerror = e => rej(e.target.error);
    });
  }

  async function getVideoDurationOnly(file) {
    return new Promise((resolve, reject) => {
      const video = document.createElement('video');
      video.preload = 'metadata';
      video.muted = true;
      video.src = URL.createObjectURL(file);
      
      video.onloadedmetadata = () => {
        const duration = video.duration;
        URL.revokeObjectURL(video.src);
        resolve(duration);
      };
      
      video.onerror = (e) => {
        URL.revokeObjectURL(video.src);
        reject(e);
      };
    });
  }

  async function generateVideoThumbnail(file) {
    return new Promise((resolve, reject) => {
      const video = document.createElement('video');
      video.preload = 'metadata';
      video.muted = true;
      video.src = URL.createObjectURL(file);
      video.crossOrigin = 'anonymous';

      video.addEventListener('loadeddata', () => {
        video.currentTime = Math.min(video.duration * 0.1, 5);
      });

      video.addEventListener('seeked', () => {
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        const duration = video.duration;
        
        URL.revokeObjectURL(video.src);
        canvas.toBlob(blob => {
          const reader = new FileReader();
          reader.onloadend = () => {
            resolve({ dataURL: reader.result, duration: duration });
          };
          reader.onerror = reject;
          reader.readAsDataURL(blob);
        }, 'image/webp', 0.8);
      });

      video.onerror = e => {
        URL.revokeObjectURL(video.src);
        reject(e);
      };
    });
  }
  
  async function enqueueThumbnail(file, imgElement, imgWrapper) {
      thumbnailQueue.push({ file, imgElement, imgWrapper });
      processThumbnailQueue();
  }

  async function processThumbnailQueue() {
      if (isProcessingQueue || thumbnailQueue.length === 0) return;
      isProcessingQueue = true;

      while (thumbnailQueue.length > 0) {
          const item = thumbnailQueue.shift();
          if(!document.body.contains(item.imgElement)) continue;

          const { file, imgElement, imgWrapper } = item;
          const key = `${file.name}-${file.size}-${file.lastModified}`;
          const prog = loadProgress({name: file.name, size: file.size, lastModified: file.lastModified});
          const hasDuration = prog && prog.duration > 0;
          
          let cached = await getThumb(key);
          
          if (cached && hasDuration) {
               imgElement.src = cached;
          } else {
              if (!cached) {
                  try {
                      const { dataURL, duration } = await generateVideoThumbnail(file);
                      await saveThumb(key, dataURL);
                      saveDuration(file, duration);
                      imgElement.src = dataURL;
                      updateSpeedCalc();
                  } catch (e) {
                      const icon = createFileIcon();
                      imgWrapper.innerHTML = '';
                      imgWrapper.appendChild(icon);
                      imgElement.style.display = 'none';
                  }
              } else {
                  imgElement.src = cached;
                  try {
                      const duration = await getVideoDurationOnly(file);
                      saveDuration(file, duration);
                      updateSpeedCalc();
                  } catch(e) {}
              }
          }
          await new Promise(r => requestAnimationFrame(r));
      }
      isProcessingQueue = false;
  }


  async function verifyPermission(handle) {
    if (!handle) return false;
    const opts = { mode: 'read' };
    if (await handle.queryPermission(opts) === 'granted') return true;
    if (await handle.requestPermission(opts) === 'granted') return true;
    return false;
  }

  function getDB() {
    return new Promise((resolve, reject) => {
      const req = indexedDB.open('folderDB', 1);
      req.onupgradeneeded = e => {
        e.target.result.createObjectStore('handles');
      };
      req.onsuccess = e => resolve(e.target.result);
      req.onerror = e => reject(e.target.error);
    });
  }

  function saveHandle(handle) {
    return getDB().then(db => {
      return new Promise((resolve, reject) => {
        const tx = db.transaction('handles', 'readwrite');
        tx.objectStore('handles').put(handle, 'videosFolder');
        tx.oncomplete = () => resolve();
        tx.onerror = e => reject(e.target.error);
      });
    });
  }

  function getHandle() {
    return getDB().then(db => {
      return new Promise((resolve, reject) => {
        const tx = db.transaction('handles', 'readonly');
        const req = tx.objectStore('handles').get('videosFolder');
        req.onsuccess = () => resolve(req.result);
        req.onerror = e => reject(e.target.error);
      });
    });
  }

  function isVideoFile(name) {
    return /\.(mp4|webm|mkv)$/i.test(name);
  }

  function createPlayIcon() {
    const wrapper = document.createElement('div');
    wrapper.className = 'play-icon';
    wrapper.innerHTML = `
      <svg viewBox="0 0 24 24" fill="white" aria-hidden="true" focusable="false">
        <path d="M8 5v14l11-7z"></path>
      </svg>`;
    return wrapper;
  }

  function createFolderIconOverlay() {
    const svgNS = "http://www.w3.org/2000/svg";
    const svg = document.createElementNS(svgNS, "svg");
    svg.setAttribute("class", "folder-icon-overlay");
    svg.setAttribute("viewBox", "0 0 24 24");
    const path = document.createElementNS(svgNS, "path");
    path.setAttribute("d", "M10 4H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-8l-2-2z");
    svg.appendChild(path);
    return svg;
  }

  async function getFolderThumbs(folderHandle) {
    let thumbs = [];
    try {
      for await (const entry of folderHandle.values()) {
        if (entry.kind === 'file' && isVideoFile(entry.name)) {
          try {
            const file = await entry.getFile();
            const key = `${file.name}-${file.size}-${file.lastModified}`;
            const cached = await getThumb(key);
            if (cached) {
              thumbs.push(cached);
              if (thumbs.length >= 4) break;
            }
          } catch {}
        }
      }
    } catch {}
    return thumbs;
  }

  function createFolderThumbCollage(thumbs) {
    if (thumbs.length === 0) {
      const svgNS = "http://www.w3.org/2000/svg";
      const svg = document.createElementNS(svgNS, "svg");
      svg.setAttribute("class", "plain-folder-icon");
      svg.setAttribute("viewBox", "0 0 24 24");
      const path = document.createElementNS(svgNS, "path");
      path.setAttribute("d", "M10 4H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-8l-2-2z");
      svg.appendChild(path);
      return svg;
    }

    const container = document.createElement("div");
    container.className = "folder-thumb";
    thumbs.forEach(src => {
      const img = document.createElement("img");
      img.src = src;
      container.appendChild(img);
    });
    for (let i = thumbs.length; i < 4; i++) {
      const filler = document.createElement("div");
      filler.style.background = "#00000000";
      filler.style.borderRadius = "4px";
      container.appendChild(filler);
    }

    const folderIcon = createFolderIconOverlay();
    folderIcon.style.position = 'absolute';
    folderIcon.style.bottom = '-6px';
    folderIcon.style.right = '-2.5px';
    folderIcon.style.width = '60px';
    folderIcon.style.height = '60px';
    folderIcon.style.zIndex = '10';
    container.appendChild(folderIcon);

    return container;
  }

  function showTitlePopup(text, rect) {
    titlePopup.textContent = text;
    titlePopup.style.display = 'block';
    const top = rect.bottom + 5;
    let left = rect.left + (rect.width / 2) - 150; 
    
    if (left < 10) left = 10;
    if (left + 300 > window.innerWidth) left = window.innerWidth - 310;
    
    titlePopup.style.top = `${top}px`;
    titlePopup.style.left = `${left}px`;
  }
  
  function hideTitlePopup() {
    titlePopup.style.display = 'none';
  }
  
  function updateSpeedCalc() {
      const speed = parseFloat(folderSpeedRange.value);
      folderSpeedDisplay.textContent = speed.toFixed(1) + 'x';
      
      let totalRemaining = 0;
      
      currentViewFiles.forEach(item => {
         const prog = loadProgress({ name: item.entry.name, size: item.file?.size, lastModified: item.file?.lastModified });
         
         if (prog) {
             const dur = prog.duration || 0;
             const time = prog.time || 0;
             const left = Math.max(0, dur - time);
             totalRemaining += left;
         } else {
         }
      });
      
      const realSeconds = totalRemaining / speed;
      folderTotalTime.textContent = formatHoursMinutes(realSeconds);
  }
  
  const savedFolderSpeed = localStorage.getItem('folderSpeed');
  if (savedFolderSpeed) {
      folderSpeedRange.value = savedFolderSpeed;
  }
  
  folderSpeedRange.addEventListener('input', () => {
      localStorage.setItem('folderSpeed', folderSpeedRange.value);
      updateSpeedCalc();
  });
  
  deleteProgressBtn.onclick = async () => {
      dropdownMenu.classList.remove('show');
      if(!currentViewFiles || currentViewFiles.length === 0) return;
      if(confirm(`Are you sure you want to reset play history and delete cached thumbnails for the ${currentViewFiles.length} videos in this folder?`)) {
          for(const item of currentViewFiles) {
              if(item.file) {
                 const key = `video-progress-${item.file.name}`;
                 localStorage.removeItem(key);
                 
                 const thumbKey = `${item.file.name}-${item.file.size}-${item.file.lastModified}`;
                 await deleteThumb(thumbKey);
              }
          }
          listFiles(currentHandle);
      }
  };
  
  function updateURL(fileName = null) {
      if(!currentHandle) return;
      const pathNames = pathStack.map(h => h.name);
      if(currentHandle !== rootHandle) pathNames.push(currentHandle.name);
      if(fileName) pathNames.push(fileName);
      
      const fullPath = "/" + pathNames.join("/");
      const url = new URL(window.location);
      url.searchParams.set('path', fullPath);
      window.history.pushState({path: fullPath}, '', url);
  }
  
  window.addEventListener('popstate', (event) => {
      restorePathFromHash();
  });

  async function listFiles(handle) {
    fileGrid.innerHTML = '';
    currentViewFiles = []; 
    thumbnailQueue = []; 
    
    try {
      const folders = [];
      const files = [];

      for await (const entry of handle.values()) {
        if (entry.kind === 'file' && isVideoFile(entry.name)) {
           try {
             const file = await entry.getFile();
             const progress = loadProgress({name: file.name, size: file.size, lastModified: file.lastModified});
             files.push({ entry, file, progress });
           } catch {
             files.push({ entry, file: null, progress: null });
           }
        } else if (entry.kind === 'directory') {
          folders.push(entry);
        }
      }

      currentViewFiles = files;
      updateSpeedCalc(); 

      if (files.length === 0 && folders.length === 0) {
        fileGrid.innerHTML = `<div class=\"no-data\">No videos or folders found.</div>`;
        return;
      }
      
      let lastPlayedIndex = -1;
      let maxTimestamp = 0;
      
      files.forEach((item, index) => {
        if (item.progress && item.progress.timestamp > maxTimestamp) {
          maxTimestamp = item.progress.timestamp;
          lastPlayedIndex = index;
        }
      });
      
      const lastPlayedItem = lastPlayedIndex > -1 ? files[lastPlayedIndex] : null;
      const otherFiles = files.filter((_, idx) => idx !== lastPlayedIndex);
      
      const inProgress = []; 
      const unplayed = [];   
      const finished = [];   
      
      otherFiles.forEach(item => {
        if (!item.progress || item.progress.time === 0) {
          unplayed.push(item);
        } else {
          const duration = item.progress.duration || 0;
          let percent = 0;
          if (duration > 0) percent = (item.progress.time / duration) * 100;
          
          if (percent >= 95) finished.push(item);
          else inProgress.push(item);
        }
      });
      
      const sortByName = (a, b) => a.entry.name.localeCompare(b.entry.name, undefined, {numeric: true, sensitivity: 'base'});
      inProgress.sort(sortByName);
      unplayed.sort(sortByName);
      finished.sort(sortByName);
      
      const sortedFiles = [];
      if (lastPlayedItem) sortedFiles.push({...lastPlayedItem, isLastPlayed: true});
      sortedFiles.push(...inProgress);
      sortedFiles.push(...unplayed);
      sortedFiles.push(...finished);
      
      folders.sort((a,b) => a.name.localeCompare(b.name));
      
      for (const entry of folders) {
          const card = document.createElement('div');
          card.className = 'card clickable';
          
          const thumbContainer = document.createElement('div');
          thumbContainer.className = 'folder-thumb';
          thumbContainer.innerHTML = '<div style="background:#333;width:100%;height:100%;border-radius:4px;"></div>'; 
          getFolderThumbs(entry).then(thumbs => {
             const newThumb = createFolderThumbCollage(thumbs);
             thumbContainer.replaceWith(newThumb);
          });
          
          card.appendChild(thumbContainer);
          
          const nameSpan = document.createElement('span');
          nameSpan.className = 'name';
          nameSpan.textContent = entry.name;
          card.appendChild(nameSpan);

          card.onclick = () => {
            forwardStack = []; 
            pathStack.push(currentHandle);
            currentHandle = entry;
            updateBreadcrumb();
            updateNavButtons();
            updateURL();
            listFiles(currentHandle);
          };
          fileGrid.appendChild(card);
      }
      
      for (const item of sortedFiles) {
        const { entry, file, progress, isLastPlayed } = item;
        const card = document.createElement('div');
        card.className = 'card clickable';
        if (isLastPlayed) card.classList.add('last-played');
        
        card.addEventListener('mouseenter', (e) => showTitlePopup(entry.name, card.getBoundingClientRect()));
        card.addEventListener('mouseleave', () => hideTitlePopup());
        
        if (progress) {
          const duration = progress.duration || 0;
          let percent = 0;
          if (duration > 0) percent = (progress.time / duration) * 100;
          if (percent > 100) percent = 100;
          
          card.style.background = `linear-gradient(to right, #3a3a3a ${percent}%, #252525 ${percent}%)`;
        }
        
        const imgWrapper = document.createElement('div');
        imgWrapper.className = 'thumb-img-wrapper';
        
        const img = document.createElement('img');
        img.className = 'thumb-img';
        img.src = 'data:image/webp;base64,UklGRrwBAABXRUJQVlA4WAoAAAAUAAAAAAAAAAAAQUxQSAIAAAAAAFZQOCAaAAAAMAEAnQEqAQABAADAEiWkAANwAP7+7qoAAABYTVAgcQEAADw/eHBhY2tldCBiZWdpbj0n77u/JyBpZD0nVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkJz8+DQo8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIj48cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPjxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSJ1dWlkOmZhZjViZGQ1LWJhM2QtMTFkYS1hZDMxLWQzM2Q3NTE4MmYxYiIgeG1sbnM6dGlmZj0iaHR0cDovL25zLmFkb2JlLmNvbS90aWZmLzEuMC8iPjx0aWZmOk9yaWVudGF0aW9uPjE8L3RpZmY6T3JpZW50YXRpb24+PC9yZGY6RGVzY3JpcHRpb24+PC9yZGY6UkRGPjwveDp4bXBtZXRhPg0KPD94cGFja2V0IGVuZD0ndyc/PgA=';
        imgWrapper.appendChild(img);

        imgWrapper.appendChild(createPlayIcon());
        card.appendChild(imgWrapper);
        
        const nameSpan = document.createElement('span');
        nameSpan.className = 'name';
        nameSpan.textContent = entry.name;
        card.appendChild(nameSpan);
        
        card.onclick = async () => {
              try {
                updateURL(entry.name);
                const f = file || await entry.getFile();
                handleFile(f);
              } catch (e) {
                alert('Failed to get file: ' + e.message);
              }
        };
        
        fileGrid.appendChild(card);
        
        if (file) {
           const key = `${file.name}-${file.size}-${file.lastModified}`;
           getThumb(key).then(thumb => {
               if(thumb) {
                   const prog = loadProgress({name: file.name, size: file.size, lastModified: file.lastModified});
                   if(!prog || !prog.duration) {
                        enqueueThumbnail(file, img, imgWrapper);
                   }
                   img.src = thumb;
               } else {
                   enqueueThumbnail(file, img, imgWrapper);
               }
           });
        }
      }

    } catch (e) {
      console.error(e);
      fileGrid.innerHTML = `<div class=\"no-data\">Unable to read folder contents.</div>`;
    }
  }

  function createFileIcon() {
    const svgNS = "http://www.w3.org/2000/svg";
    const svg = document.createElementNS(svgNS, "svg");
    svg.setAttribute("class", "file-icon");
    svg.setAttribute("viewBox", "0 0 24 24");
    svg.style.position = 'absolute';
    svg.style.bottom = '-6px';
    svg.style.right = '-2.5px';
    svg.style.width = '60px';
    svg.style.height = '60px';
    svg.style.zIndex = '10';
    svg.style.background = 'transparent';

    const path = document.createElementNS(svgNS, "path");
    path.setAttribute("d", "M6 2h9l5 5v15a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2zM14 3v5h5");
    path.setAttribute("fill", "#6c6c6c");
    svg.appendChild(path);

    return svg;
  }

  function updateBreadcrumb() {
    breadcrumb.innerHTML = '';

    const rootSpan = document.createElement('span');
    rootSpan.textContent = 'Videos Folder';
    rootSpan.style.userSelect = 'none';
    rootSpan.style.cursor = 'pointer';
    rootSpan.onclick = () => {
      if (currentHandle !== rootHandle) {
        forwardStack = [];
        pathStack = [];
        currentHandle = rootHandle;
        updateBreadcrumb();
        updateNavButtons();
        updateURL();
        listFiles(currentHandle);
      }
    };
    breadcrumb.appendChild(rootSpan);

    pathStack.forEach((handle, i) => {
      const sep = document.createTextNode(' / ');
      breadcrumb.appendChild(sep);
      const span = document.createElement('span');
      span.textContent = handle.name || `Folder ${i + 1}`;
      span.style.cursor = 'pointer';
      span.style.userSelect = 'none';
      span.onclick = () => {
        if (currentHandle !== handle) {
          forwardStack = [];
          pathStack = pathStack.slice(0, i);
          currentHandle = handle;
          updateBreadcrumb();
          updateNavButtons();
          updateURL();
          listFiles(currentHandle);
        }
      };
      breadcrumb.appendChild(span);
    });
  }

  function updateNavButtons() {
    backBtn.disabled = pathStack.length === 0;
    forwardBtn.disabled = forwardStack.length === 0;
    homeBtn.disabled = (currentHandle === rootHandle || !rootHandle);
  }

  backBtn.onclick = () => {
    if (pathStack.length > 0) {
      forwardStack.push(currentHandle);
      currentHandle = pathStack.pop();
      updateBreadcrumb();
      updateNavButtons();
      updateURL();
      listFiles(currentHandle);
    }
  };

  forwardBtn.onclick = () => {
    if (forwardStack.length > 0) {
      pathStack.push(currentHandle);
      currentHandle = forwardStack.pop();
      updateBreadcrumb();
      updateNavButtons();
      updateURL();
      listFiles(currentHandle);
    }
  };

  homeBtn.onclick = () => {
    if (rootHandle && currentHandle !== rootHandle) {
      forwardStack = [];
      pathStack = [];
      currentHandle = rootHandle;
      updateBreadcrumb();
      updateNavButtons();
      updateURL();
      listFiles(currentHandle);
    }
  };
  
  async function restorePathFromHash() {
      const params = new URLSearchParams(window.location.search);
      const pathStr = params.get('path');
      if (pathStr) {
          video.pause();
          playerContainer.style.display = 'none';
          document.getElementById('dropzone').style.display = 'none';
          document.getElementById('browseropen').style.display = 'none';
          if(dailyStatsEl) dailyStatsEl.style.display = 'block';
      }

      if(!pathStr || !rootHandle) return;
      
      const parts = pathStr.split('/').filter(p => p && p !== 'Videos Folder'); 
      let target = rootHandle;
      const stack = [];
      let targetFile = null;
      
      try {
          for(let i = 0; i < parts.length; i++) {
             const part = parts[i];
             if (i === 0 && part === rootHandle.name) continue;
             if (i === parts.length - 1 && isVideoFile(part)) {
                 targetFile = part;
                 break; 
             }

             const nextHandle = await target.getDirectoryHandle(part);
             stack.push(target);
             target = nextHandle;
          }
          pathStack = stack;
          currentHandle = target;
          updateBreadcrumb();
          updateNavButtons();
          await listFiles(currentHandle);

          if (targetFile) {
              try {
                  const fileHandle = await currentHandle.getFileHandle(targetFile);
                  const file = await fileHandle.getFile();
                  handleFile(file);
              } catch (err) {
                  console.log("File in path not found: " + targetFile);
              }
          }
      } catch(e) {
          console.log("Invalid path, resetting to root", e);
          const url = new URL(window.location);
          url.searchParams.delete('path');
          window.history.replaceState({}, '', url);
          
          currentHandle = rootHandle;
          pathStack = [];
          updateBreadcrumb();
          updateNavButtons();
          listFiles(currentHandle);
      }
  }

  async function init() {
    try {
      const handle = await getHandle();
      if (handle && await verifyPermission(handle)) {
        rootHandle = handle;
        currentHandle = handle;
        pathStack = [];
        forwardStack = [];
        
        await restorePathFromHash(); 
        
        if (currentHandle === rootHandle && !window.location.search.includes('path=')) {
           updateBreadcrumb();
           updateNavButtons();
           await listFiles(currentHandle);
        }
        return;
      }
    } catch {}
    fileGrid.innerHTML = `<div class=\"no-data\">No folder selected or permission denied.</div>`;
  }

  pickBtn.addEventListener('click', async () => {
    try {
      const dirHandle = await window.showDirectoryPicker();
      if (await verifyPermission(dirHandle)) {
        await saveHandle(dirHandle);
        rootHandle = dirHandle;
        currentHandle = dirHandle;
        pathStack = [];
        forwardStack = [];
        updateBreadcrumb();
        updateNavButtons();
        updateURL();
        await listFiles(currentHandle);
      } else {
        alert('Permission denied for this folder.');
      }
    } catch (e) {
      if (e.name !== 'AbortError') alert('Error: ' + e.message);
    }
  });

  init();
})();


(function() {
    const loader = document.getElementById('loader-overlay');
    if (!loader) return;
    const stage = loader.querySelector('.l-stage');
    const todayKey = new Date().toDateString(); 
    const lastOpened = localStorage.getItem('lastopened');
    const dismissLoader = () => {
        loader.classList.add('dismissing');
        loader.addEventListener('animationend', (e) => {
            if (e.animationName === 'fadeOutBg') {
                loader.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        });
    };
    
    if (lastOpened === todayKey) {
        loader.classList.add('fast-mode');
        setTimeout(() => {
            if (document.readyState === 'complete') {
                 dismissLoader();
            } else {
                loader.classList.add('bouncing');
                const checkInterval = setInterval(() => {
                    if (document.readyState === 'complete') {
                        clearInterval(checkInterval);
                        loader.classList.remove('bouncing');
                        dismissLoader();
                    }
                }, 100);
            }
        }, 500);
        
    } else {
        localStorage.setItem('lastopened', todayKey);
        let isPageLoaded = document.readyState === 'complete';
        if (!isPageLoaded) {
            window.addEventListener('load', () => {
                isPageLoaded = true;
            });
        }
        setTimeout(() => {
            if (isPageLoaded) {
                dismissLoader(); 
            } else {
                loader.classList.add('bouncing');
                const checkInterval = setInterval(() => {
                    if (document.readyState === 'complete') {
                       clearInterval(checkInterval);
                       loader.classList.remove('bouncing');
                       dismissLoader();
                    }
                }, 100);
            }
        }, 1400);
    }
})();
(function() {
    const loader = document.getElementById('loader-overlay');
    if (!loader) return;

    const wastedWarn = document.getElementById('wastedtimewarn');
    const wastedSpan = document.getElementById('wastedtimespan');

    if (!wastedWarn || !wastedSpan) return;

    let wastedTimer = null;
    let wastedStart = 0;
    let warned = false;
    let stopped = false;
    const applyStyles = () => {
        Object.assign(wastedWarn.style, {
            position: 'fixed',
            bottom: '20px',
            left: '50%',
            transform: 'translateX(-50%)',
            backgroundColor: 'rgba(40, 40, 40, 0.6)', 
            backdropFilter: 'blur(10px)',           
            webkitBackdropFilter: 'blur(10px)',     
            color: '#fff',
            padding: '10px 20px',
            borderRadius: '8px',
            fontSize: '14px',
            fontFamily: 'sans-serif',
            zIndex: '99999',
            boxShadow: '0 4px 6px rgba(0,0,0,0.1)',
            border: '1px solid rgba(255,255,255,0.1)'
        });
    };

    const showWarn = () => {
        applyStyles();
        wastedWarn.style.display = 'block'; 
        wastedWarn.removeAttribute('hidden');
    };
    const hideWarn = () => {
        wastedWarn.style.display = 'none';
        wastedWarn.setAttribute('hidden', 'true');
    };

    const stopWastedTimer = (hide = true) => {
        if (wastedTimer) {
            clearInterval(wastedTimer);
            wastedTimer = null;
        }
        stopped = true;
        if (hide) hideWarn();
    };

    const startWastedTimer = () => {
        if (wastedTimer || stopped) return;
        wastedStart = Date.now();
        showWarn();
        warned = true;
        updateWastedSpan();
        wastedTimer = setInterval(() => {
            updateWastedSpan();
        }, 1000);
    };

    const updateWastedSpan = () => {
        const elapsedMs = Date.now() - wastedStart;
        const seconds = Math.floor(elapsedMs / 1000) + 1;
        wastedWarn.textContent = `Wasted ${seconds} seconds because of slow internet`;
        if (document.readyState === 'complete' && seconds < 59) {
            stopWastedTimer(true);
        }
        if (seconds >= 59 && document.readyState !== 'complete') {
            stopWastedTimer(false);
            try {
                setTimeout(() => location.reload(), 250);
            } catch (err) {
                hideWarn();
            }
        }
    };

    const onAnimationEnd = (e) => {
        if (loader.classList.contains('bouncing')) {
            if (!warned && !stopped) {
                startWastedTimer();
            }
        }
        if (e.animationName === 'fadeOutBg') {
            stopWastedTimer(true);
        }
    };
    loader.addEventListener('animationend', onAnimationEnd, { passive: true });

    const mo = new MutationObserver((mutations) => {
        for (const m of mutations) {
            if (m.attributeName === 'class') {
                const isBouncing = loader.classList.contains('bouncing');
                
                if (isBouncing && !warned && !stopped) {
                    startWastedTimer();
                }

                if (!isBouncing && warned) {
                    if (document.readyState === 'complete') stopWastedTimer(true);
                }
            }
        }
    });
    mo.observe(loader, { attributes: true });
    window.addEventListener('load', () => {
        if (wastedTimer) stopWastedTimer(true);
    });
    if (loader.classList.contains('bouncing')) {
        setTimeout(() => {
            if (!warned && !stopped && document.readyState !== 'complete') startWastedTimer();
        }, 300);
    }
})();
</script>
</body>
</html>
